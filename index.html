<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>免费 TTS 播放器</title>
  <style>
    body { font-family: sans-serif; margin: 20px; }
    textarea { width: 100%; height: 150px; font-size: 16px; }
    .controls { margin-top: 10px; }
    #progressBar {
      width: 100%; 
      height: 20px; 
      background: #eee; 
      margin-top: 10px; 
      border-radius: 5px; 
      overflow: hidden;
    }
    #progressFill {
      height: 100%; 
      width: 0%; 
      background: #4caf50;
    }
  </style>
</head>
<body>
  <h2>免费 TTS 播放器（英语 / 丹麦语）</h2>

  <textarea id="textInput" placeholder="输入文字..."></textarea><br><br>

  <div class="controls">
    <label>语言：
      <select id="langSelect">
        <option value="en">英语</option>
        <option value="da">丹麦语</option>
      </select>
    </label>
    <br><br>

    <label>声音：
      <select id="voiceSelect"></select>
    </label>
    <br><br>

    <label>语速：
      <input type="range" id="rateControl" min="0.5" max="2" step="0.1" value="1">
      <span id="rateValue">1.0</span>x
    </label>
    <br><br>

    <label>音量：
      <input type="range" id="volumeControl" min="0" max="1" step="0.1" value="1">
      <span id="volumeValue">100%</span>
    </label>
  </div>
  <br>

  <button id="playBtn">播放</button>
  <button id="pauseBtn">暂停</button>
  <button id="stopBtn">停止</button>

  <div id="progressBar">
    <div id="progressFill"></div>
  </div>

  <script>
    const textInput = document.getElementById('textInput');
    const playBtn = document.getElementById('playBtn');
    const pauseBtn = document.getElementById('pauseBtn');
    const stopBtn = document.getElementById('stopBtn');
    const langSelect = document.getElementById('langSelect');
    const rateControl = document.getElementById('rateControl');
    const rateValue = document.getElementById('rateValue');
    const volumeControl = document.getElementById('volumeControl');
    const volumeValue = document.getElementById('volumeValue');
    const voiceSelect = document.getElementById('voiceSelect');
    const progressFill = document.getElementById('progressFill');

    let utterance;
    let isPaused = false;
    let resumeIndex = 0; // 停止位置继续
    let currentText = "";

    // 自动保存文本
    textInput.value = localStorage.getItem('savedText') || '';
    textInput.addEventListener('input', () => {
      localStorage.setItem('savedText', textInput.value);
    });

    // 语速 & 音量显示
    rateControl.oninput = () => rateValue.textContent = rateControl.value;
    volumeControl.oninput = () => volumeValue.textContent = Math.round(volumeControl.value * 100) + "%";

    // 加载声音列表
    function loadVoices() {
      const voices = speechSynthesis.getVoices();
      voiceSelect.innerHTML = "";
      voices.forEach((v, i) => {
        const option = document.createElement("option");
        option.value = i;
        option.textContent = `${v.name} (${v.lang})`;
        voiceSelect.appendChild(option);
      });
    }
    speechSynthesis.onvoiceschanged = loadVoices;
    loadVoices();

    // 播放
    function playText() {
      if (speechSynthesis.speaking && isPaused) {
        speechSynthesis.resume();
        isPaused = false;
      } else if (!speechSynthesis.speaking) {
        currentText = textInput.value;
        if (!currentText) return;

        // 从光标 或 上次停止位置 开始
        let startIndex = resumeIndex || textInput.selectionStart || 0;
        const playText = currentText.substring(startIndex);

        utterance = new SpeechSynthesisUtterance(playText);
        const voices = speechSynthesis.getVoices();
        const chosenVoice = voices[voiceSelect.value];
        if (chosenVoice) utterance.voice = chosenVoice;
        utterance.lang = langSelect.value;
        utterance.rate = parseFloat(rateControl.value);
        utterance.volume = parseFloat(volumeControl.value);

        // 高亮 + 进度条
        utterance.onboundary = (e) => {
          if (e.name === "word" || e.name === "sentence") {
            const charIndex = startIndex + e.charIndex;
            textInput.focus();
            textInput.setSelectionRange(charIndex, charIndex + 1);
            resumeIndex = charIndex;

            // 更新进度条
            const percent = Math.min(100, Math.round((charIndex / currentText.length) * 100));
            progressFill.style.width = percent + "%";
          }
        };

        // 播放结束后重置
        utterance.onend = () => {
          resumeIndex = 0;
          progressFill.style.width = "0%";
        };

        speechSynthesis.speak(utterance);
      }
    }

    playBtn.onclick = playText;

    // 暂停
    pauseBtn.onclick = () => {
      if (speechSynthesis.speaking) {
        speechSynthesis.pause();
        isPaused = true;
      }
    };

    // 停止
    stopBtn.onclick = () => {
      if (speechSynthesis.speaking) {
        speechSynthesis.cancel();
        isPaused = false;
      }
    };

    // 空格键控制 播放/暂停
    document.addEventListener('keydown', (e) => {
      if (e.code === "Space" && !e.target.matches("textarea, input, select")) {
        e.preventDefault();
        if (speechSynthesis.speaking) {
          if (isPaused) {
            speechSynthesis.resume();
            isPaused = false;
          } else {
            speechSynthesis.pause();
            isPaused = true;
          }
        } else {
          playText();
        }
      }
    });
  </script>
</body>
</html>
